{% extends "base.html" %}
{% block page_panel %}
<div class="recipe-view-container">
    <form method="POST" enctype="multipart/form-data" id="categoryRecipeForm">
        <div class="recipe-title-section">
            <input type="text" id="recipe-title" name="title" required value="{{ recipe.title }}" placeholder="Enter recipe name" title="Recipe Name" class="recipe-title-input">
        </div>
        <div class="recipe-view-layout">
            <div class="recipe-table-section">
                <table class="recipe-cost-table" id="ingredientsTable">
                    <thead>
                        <tr>
                            <th class="actions-column-left"></th>
                            <th class="code-cell">CODE</th>
                            <th class="description-cell">DESCRIPTION</th>
                            <th class="unit-qty-cell">UNIT QTY</th>
                            <th class="recipe-ml-cell">RECIPE QTY</th>
                            <th class="cost-cell">RECIPE COST</th>
                            <th class="actions-column-right"></th>
                        </tr>
                    </thead>
                    <tbody id="ingredientRows">
                        <!-- Rows will be added here by JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td></td>
                            <td colspan="4"><strong>Total</strong></td>
                            <td class="cost-cell"><strong id="totalCostDisplay">AED 0.00</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="recipe-sidebar">
                <div class="method-section">
                    <div class="section-header">METHOD</div>
                    <div class="section-content">
                        <textarea id="recipe-method" name="method" rows="8" placeholder="Enter preparation method" class="section-textarea">{{ recipe.method or '' }}</textarea>
                    </div>
                </div>

                <div class="garnish-section">
                    <div class="section-header">GARNISH:</div>
                    <div class="section-content">
                        <textarea id="recipe-garnish" name="garnish" rows="4" placeholder="Enter garnish details (optional)" class="section-textarea section-textarea-small">{{ recipe.garnish or '' }}</textarea>
                    </div>
                </div>

                <div class="category-section">
                    <div class="section-header">CATEGORY:</div>
                    <div class="section-content">
                        <select id="recipe-food-category" name="food_category" title="Category" class="section-select">
                            <option value="">Select Category (optional)</option>
                            <!-- Cocktails -->
                            <option value="Classic Cocktail" {% if recipe.food_category == 'Classic Cocktail' %}selected{% endif %}>Classic Cocktail</option>
                            <option value="Signature Cocktail" {% if recipe.food_category == 'Signature Cocktail' %}selected{% endif %}>Signature Cocktail</option>
                            <option value="Mocktail" {% if recipe.food_category == 'Mocktail' %}selected{% endif %}>Mocktail</option>
                            <!-- Wines -->
                            <option value="Red Wine GLS" {% if recipe.food_category == 'Red Wine GLS' %}selected{% endif %}>Red Wine GLS</option>
                            <option value="Red Wine BTL" {% if recipe.food_category == 'Red Wine BTL' %}selected{% endif %}>Red Wine BTL</option>
                            <option value="White Wine GLS" {% if recipe.food_category == 'White Wine GLS' %}selected{% endif %}>White Wine GLS</option>
                            <option value="White Wine BTL" {% if recipe.food_category == 'White Wine BTL' %}selected{% endif %}>White Wine BTL</option>
                            <option value="Rose Wine GLS" {% if recipe.food_category == 'Rose Wine GLS' %}selected{% endif %}>Rose Wine GLS</option>
                            <option value="Rose Wine BTL" {% if recipe.food_category == 'Rose Wine BTL' %}selected{% endif %}>Rose Wine BTL</option>
                            <option value="Sparkling Wine GLS" {% if recipe.food_category == 'Sparkling Wine GLS' %}selected{% endif %}>Sparkling Wine GLS</option>
                            <option value="Sparkling Wine BTL" {% if recipe.food_category == 'Sparkling Wine BTL' %}selected{% endif %}>Sparkling Wine BTL</option>
                            <option value="Sweet Wine GLS" {% if recipe.food_category == 'Sweet Wine GLS' %}selected{% endif %}>Sweet Wine GLS</option>
                            <option value="Sweet Wine BTL" {% if recipe.food_category == 'Sweet Wine BTL' %}selected{% endif %}>Sweet Wine BTL</option>
                            <!-- Spirits -->
                            <option value="Vodka SHT" {% if recipe.food_category == 'Vodka SHT' %}selected{% endif %}>Vodka SHT</option>
                            <option value="Vodka BTL" {% if recipe.food_category == 'Vodka BTL' %}selected{% endif %}>Vodka BTL</option>
                            <option value="Gin SHT" {% if recipe.food_category == 'Gin SHT' %}selected{% endif %}>Gin SHT</option>
                            <option value="Gin BTL" {% if recipe.food_category == 'Gin BTL' %}selected{% endif %}>Gin BTL</option>
                            <option value="Rum SHT" {% if recipe.food_category == 'Rum SHT' %}selected{% endif %}>Rum SHT</option>
                            <option value="Rum BTL" {% if recipe.food_category == 'Rum BTL' %}selected{% endif %}>Rum BTL</option>
                            <option value="Tequila SHT" {% if recipe.food_category == 'Tequila SHT' %}selected{% endif %}>Tequila SHT</option>
                            <option value="Tequila BTL" {% if recipe.food_category == 'Tequila BTL' %}selected{% endif %}>Tequila BTL</option>
                            <option value="Whiskey SHT" {% if recipe.food_category == 'Whiskey SHT' %}selected{% endif %}>Whiskey SHT</option>
                            <option value="Whiskey BTL" {% if recipe.food_category == 'Whiskey BTL' %}selected{% endif %}>Whiskey BTL</option>
                            <option value="Whisky SHT" {% if recipe.food_category == 'Whisky SHT' %}selected{% endif %}>Whisky SHT</option>
                            <option value="Whisky BTL" {% if recipe.food_category == 'Whisky BTL' %}selected{% endif %}>Whisky BTL</option>
                            <option value="Brandy SHT" {% if recipe.food_category == 'Brandy SHT' %}selected{% endif %}>Brandy SHT</option>
                            <option value="Brandy BTL" {% if recipe.food_category == 'Brandy BTL' %}selected{% endif %}>Brandy BTL</option>
                            <option value="Cognac SHT" {% if recipe.food_category == 'Cognac SHT' %}selected{% endif %}>Cognac SHT</option>
                            <option value="Cognac BTL" {% if recipe.food_category == 'Cognac BTL' %}selected{% endif %}>Cognac BTL</option>
                            <!-- Beer -->
                            <option value="Beer Draught" {% if recipe.food_category == 'Beer Draught' %}selected{% endif %}>Beer Draught</option>
                            <option value="Beer Bottle" {% if recipe.food_category == 'Beer Bottle' %}selected{% endif %}>Beer Bottle</option>
                            <!-- Amaro & Vermouth -->
                            <option value="Amaro SHT" {% if recipe.food_category == 'Amaro SHT' %}selected{% endif %}>Amaro SHT</option>
                            <option value="Amaro BTL" {% if recipe.food_category == 'Amaro BTL' %}selected{% endif %}>Amaro BTL</option>
                            <option value="Vermouth SHT" {% if recipe.food_category == 'Vermouth SHT' %}selected{% endif %}>Vermouth SHT</option>
                            <option value="Vermouth BTL" {% if recipe.food_category == 'Vermouth BTL' %}selected{% endif %}>Vermouth BTL</option>
                            <!-- Liqueurs -->
                            <option value="Generic Liqueur SHT" {% if recipe.food_category == 'Generic Liqueur SHT' %}selected{% endif %}>Generic Liqueur SHT</option>
                            <option value="Generic Liqueur BTL" {% if recipe.food_category == 'Generic Liqueur BTL' %}selected{% endif %}>Generic Liqueur BTL</option>
                            <option value="Branded Liqueur SHT" {% if recipe.food_category == 'Branded Liqueur SHT' %}selected{% endif %}>Branded Liqueur SHT</option>
                            <option value="Branded Liqueur BTL" {% if recipe.food_category == 'Branded Liqueur BTL' %}selected{% endif %}>Branded Liqueur BTL</option>
                            <!-- Food Categories -->
                            <option value="Coffee" {% if recipe.food_category == 'Coffee' %}selected{% endif %}>Coffee</option>
                            <option value="Tea" {% if recipe.food_category == 'Tea' %}selected{% endif %}>Tea</option>
                            <option value="Pizza" {% if recipe.food_category == 'Pizza' %}selected{% endif %}>Pizza</option>
                            <option value="Pasta" {% if recipe.food_category == 'Pasta' %}selected{% endif %}>Pasta</option>
                            <option value="Dessert" {% if recipe.food_category == 'Dessert' %}selected{% endif %}>Dessert</option>
                            <option value="Grill" {% if recipe.food_category == 'Grill' %}selected{% endif %}>Grill</option>
                            <option value="Soups" {% if recipe.food_category == 'Soups' %}selected{% endif %}>Soups</option>
                            <option value="Salad" {% if recipe.food_category == 'Salad' %}selected{% endif %}>Salad</option>
                            <option value="Smoothie" {% if recipe.food_category == 'Smoothie' %}selected{% endif %}>Smoothie</option>
                            <option value="Cold Cuts" {% if recipe.food_category == 'Cold Cuts' %}selected{% endif %}>Cold Cuts</option>
                            <option value="Appetizers" {% if recipe.food_category == 'Appetizers' %}selected{% endif %}>Appetizers</option>
                            <option value="Sides" {% if recipe.food_category == 'Sides' %}selected{% endif %}>Sides</option>
                            <option value="Mains" {% if recipe.food_category == 'Mains' %}selected{% endif %}>Mains</option>
                            <option value="Bread" {% if recipe.food_category == 'Bread' %}selected{% endif %}>Bread</option>
                            <option value="Rice" {% if recipe.food_category == 'Rice' %}selected{% endif %}>Rice</option>
                            <option value="Snacks or Finger Food" {% if recipe.food_category == 'Snacks or Finger Food' %}selected{% endif %}>Snacks or Finger Food</option>
                            <option value="Fusion" {% if recipe.food_category == 'Fusion' %}selected{% endif %}>Fusion</option>
                        </select>
                    </div>
                </div>

                <div class="recipe-details-section">
                    <div class="section-header">RECIPE DETAILS</div>
                    <div class="summary-box">
                        <div class="summary-row">
                            <span class="summary-label">RECIPE COST:</span>
                            <span class="summary-value" id="sidebarTotalCost">AED 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">SELLING PRICE:</span>
                            <span class="summary-value">
                                <input type="number" id="recipe-selling-price" step="0.01" min="0" name="selling_price" title="Selling Price (AED)" value="{{ recipe.selling_price or '0' }}" placeholder="0.00" class="sidebar-input">
                            </span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">VAT %:</span>
                            <span class="summary-value">
                                <input type="number" id="recipe-vat-percentage" step="0.01" min="0" max="100" name="vat_percentage" title="VAT Percentage" value="{{ recipe.vat_percentage or '0' }}" placeholder="0.00" class="sidebar-input">
                            </span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">SERVICE CHARGE %:</span>
                            <span class="summary-value">
                                <input type="number" id="recipe-service-charge-percentage" step="0.01" min="0" max="100" name="service_charge_percentage" title="Service Charge Percentage" value="{{ recipe.service_charge_percentage or '0' }}" placeholder="0.00" class="sidebar-input">
                            </span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">GOVERNMENT FEES %:</span>
                            <span class="summary-value">
                                <input type="number" id="recipe-government-fees-percentage" step="0.01" min="0" max="100" name="government_fees_percentage" title="Government Fees Percentage" value="{{ recipe.government_fees_percentage or '0' }}" placeholder="0.00" class="sidebar-input">
                            </span>
                        </div>
                        <div class="summary-row cost-percent-row">
                            <span class="summary-label">COST % OF SP:</span>
                            <span class="summary-value" id="costPercentDisplay">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <datalist id="ingredient-options">
            {% for option in ingredient_options %}
            <option value="{{ option.label }}" data-id="{{ option.id }}" data-type="{{ option.type }}" data-cost="{{ option.cost_per_unit }}" data-volume="{{ option.container_volume }}" data-code="{{ option.code }}"></option>
            {% endfor %}
        </datalist>

        <div class="actions recipe-actions">
            <button type="submit" class="btn">Update Recipe</button>
            <a href="{{ url_for('recipes.recipes_list') }}" class="btn secondary">Cancel</a>
        </div>
    </form>
</div>

<script id="ingredient-data" type="application/json">{{ ingredient_options|tojson|safe }}</script>
<script id="preset-rows-data" type="application/json">{{ preset_rows|tojson|safe }}</script>
<script>
const ingredientDataEl = document.getElementById('ingredient-data');
const presetRowsDataEl = document.getElementById('preset-rows-data');

if (!ingredientDataEl || !presetRowsDataEl) {
    console.error('Missing required data elements');
}

const ingredientOptions = ingredientDataEl ? JSON.parse(ingredientDataEl.textContent) : [];
const presetRows = presetRowsDataEl ? JSON.parse(presetRowsDataEl.textContent) : [];
const rowsContainer = document.getElementById('ingredientRows');
const totalCostDisplay = document.getElementById('totalCostDisplay');
const sidebarTotalCost = document.getElementById('sidebarTotalCost');
const sellingPriceInput = document.getElementById('recipe-selling-price');
const costPercentDisplay = document.getElementById('costPercentDisplay');

if (!rowsContainer || !totalCostDisplay || !sidebarTotalCost || !costPercentDisplay) {
    console.error('Missing required DOM elements');
}


const optionMap = {};
ingredientOptions.forEach(function(opt) {
    const labelKey = (opt.label || '').toLowerCase();
    if (labelKey) {
        optionMap[labelKey] = opt;
        const simple = labelKey.split('(')[0].trim();
        if (simple && !optionMap[simple]) {
            optionMap[simple] = opt;
        }
    }
    const descriptionKey = (opt.description || '').toLowerCase();
    if (descriptionKey) {
        optionMap[descriptionKey] = opt;
    }
    if (opt.code) {
        optionMap[String(opt.code).toLowerCase()] = opt;
    }
});

function findOption(label) {
    if (!label) return null;
    const key = label.trim().toLowerCase();
    if (optionMap[key]) return optionMap[key];
    const simple = key.split('(')[0].trim().toLowerCase();
    if (simple && optionMap[simple]) {
        return optionMap[simple];
    }
    return null;
}

function createRow(initialData) {
    initialData = initialData || {};
    const row = document.createElement('tr');
    row.className = 'ingredient-row';
    
    const rowId = 'row_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    row.innerHTML = `
        <td class="actions-cell-left">
            <button type="button" class="btn-remove-row" title="Remove Row">-</button>
        </td>
        <td class="code-cell">-</td>
        <td class="description-cell">
            <input type="text" name="ingredient_label" list="ingredient-options" placeholder="Type ingredient name" autocomplete="off" value="${initialData.description || initialData.label || ''}" class="ingredient-input table-input">
            <input type="hidden" name="ingredient_id" value="${initialData.id || ''}">
            <input type="hidden" name="ingredient_type" value="${initialData.type || ''}">
            <input type="hidden" name="ingredient_unit" value="${initialData.unit || 'ml'}">
        </td>
        <td class="unit-qty-cell">-</td>
        <td class="recipe-ml-cell">
            <input type="number" step="0.01" min="0" name="ingredient_qty" placeholder="0.00" value="${initialData.qty || ''}" class="qty-input table-input table-input-right">
        </td>
        <td class="cost-cell"><span class="row-cost">AED 0.00</span></td>
        <td class="actions-cell-right">
            <button type="button" class="btn-add-row" title="Add Row">+</button>
        </td>
    `;

    const input = row.querySelector('.ingredient-input');
    const qtyInput = row.querySelector('.qty-input');
    const codeCell = row.querySelector('.code-cell');
    const descriptionCell = row.querySelector('.description-cell');
    const unitQtyCell = row.querySelector('.unit-qty-cell');
    const costDisplay = row.querySelector('.row-cost');
    const hiddenId = row.querySelector('input[name="ingredient_id"]');
    const hiddenType = row.querySelector('input[name="ingredient_type"]');
    const hiddenUnit = row.querySelector('input[name="ingredient_unit"]');

    function updateRowCost() {
        const option = findOption(input.value);
        const quantity = parseFloat(qtyInput.value || 0);
        let cost = 0;
        let code = initialData.code || '-';
        let unitQty = '-';
        let descriptionText = initialData.description || input.value;
        
        if (option) {
            hiddenId.value = option.id || '';
            hiddenType.value = option.type || '';
            hiddenUnit.value = option.unit || 'ml';
            code = option.code || code || '-';
            unitQty = option.container_volume ? parseFloat(option.container_volume).toFixed(0) : '-';
            descriptionText = option.description || option.label?.split('(')[0].trim() || descriptionText;
            
            const costPerUnit = parseFloat(option.cost_per_unit || 0);
            const containerVolume = parseFloat(option.container_volume || 0);
            let unitCost = costPerUnit;
            if (containerVolume > 0) {
                unitCost = costPerUnit / containerVolume;
            }
            cost = unitCost * quantity;
        } else {
            hiddenId.value = '';
            hiddenType.value = '';
            hiddenUnit.value = 'ml';
        }
        
        if (descriptionText) {
            input.value = descriptionText;
        }
        codeCell.textContent = code || '-';
        unitQtyCell.textContent = unitQty;
        costDisplay.textContent = 'AED ' + cost.toFixed(2);
        updateTotalCost();
    }

    input.addEventListener('input', function() {
        updateRowCost();
    });
    
    input.addEventListener('blur', function() {
        const option = findOption(input.value);
        if (option) {
            input.value = option.description || option.label;
            updateRowCost();
        }
    });
    
    qtyInput.addEventListener('input', function() {
        updateRowCost();
    });

    row.querySelector('.btn-remove-row').addEventListener('click', function() {
        row.remove();
        updateTotalCost();
    });
    
    row.querySelector('.btn-add-row').addEventListener('click', function() {
        createRow();
    });

    rowsContainer.appendChild(row);
    
    // If initial data is provided, find the option and set values properly
    if (initialData && (initialData.id || initialData.label)) {
        let option = null;
        // Try to find option by ID and type first (most reliable)
        if (initialData.id && initialData.type) {
            for (let opt of ingredientOptions) {
                // Use String() to ensure type matching works correctly
                if (String(opt.id) === String(initialData.id) && opt.type === initialData.type) {
                    option = opt;
                    break;
                }
            }
        }
        // Fallback to label/description matching
        if (!option && initialData.label) {
            option = findOption(initialData.label);
        }
        if (!option && initialData.description) {
            option = findOption(initialData.description);
        }
        
        if (option) {
            // Set the input to the option's description for display
            input.value = option.description || option.label;
            hiddenId.value = String(option.id || '');
            hiddenType.value = option.type || '';
            hiddenUnit.value = option.unit || initialData.unit || 'ml';
        } else if (initialData.label) {
            // If option not found but we have a label, use it
            input.value = initialData.description || initialData.label;
            if (initialData.id) {
                hiddenId.value = String(initialData.id);
            }
            if (initialData.type) {
                hiddenType.value = initialData.type;
            }
            hiddenUnit.value = initialData.unit || 'ml';
        }
        
        // Set quantity if provided
        if (initialData.qty !== undefined && initialData.qty !== null && initialData.qty !== '') {
            qtyInput.value = initialData.qty;
        }
    }
    
    // Update row cost which will populate code, unit qty, and cost
    // This will also try to find the option again based on the input value
    updateRowCost();
}

function updateTotalCost() {
    let total = 0;
    rowsContainer.querySelectorAll('.row-cost').forEach(function(span) {
        const value = parseFloat(span.textContent.replace('AED', '').trim() || 0);
        total += value;
    });
    const totalStr = 'AED ' + total.toFixed(2);
    totalCostDisplay.innerHTML = '<strong>' + totalStr + '</strong>';
    sidebarTotalCost.textContent = totalStr;
    
    // Update cost percentage
    // Selling price is inclusive of VAT, Service Charge, and Government Fees
    // Calculate base selling price by deducting fees
    const sellingPrice = parseFloat(sellingPriceInput.value || 0);
    const vatInput = document.getElementById('recipe-vat-percentage');
    const serviceChargeInput = document.getElementById('recipe-service-charge-percentage');
    const govtFeesInput = document.getElementById('recipe-government-fees-percentage');
    
    const vatPercent = parseFloat(vatInput?.value || 0) || 0;
    const serviceChargePercent = parseFloat(serviceChargeInput?.value || 0) || 0;
    const govtFeesPercent = parseFloat(govtFeesInput?.value || 0) || 0;
    
    if (sellingPrice > 0) {
        // Calculate base selling price (before fees)
        // SP_inclusive = Base_SP Ã— (1 + fees/100)
        // Base_SP = SP_inclusive / (1 + fees/100)
        const totalFeesPercent = vatPercent + serviceChargePercent + govtFeesPercent;
        let baseSellingPrice = sellingPrice;
        if (totalFeesPercent > 0) {
            baseSellingPrice = sellingPrice / (1 + totalFeesPercent / 100);
        }
        const percent = (total / baseSellingPrice) * 100;
        costPercentDisplay.textContent = percent.toFixed(2) + '%';
    } else {
        costPercentDisplay.textContent = '--';
    }
}

// Update cost when selling price or fees change
if (sellingPriceInput) {
    sellingPriceInput.addEventListener('input', function() {
        updateTotalCost();
    });
}

const vatInput = document.getElementById('recipe-vat-percentage');
const serviceChargeInput = document.getElementById('recipe-service-charge-percentage');
const govtFeesInput = document.getElementById('recipe-government-fees-percentage');

if (vatInput) {
    vatInput.addEventListener('input', updateTotalCost);
}
if (serviceChargeInput) {
    serviceChargeInput.addEventListener('input', updateTotalCost);
}
if (govtFeesInput) {
    govtFeesInput.addEventListener('input', updateTotalCost);
}


if (presetRows && presetRows.length > 0) {
    presetRows.forEach(function(row) {
        // Skip rows with null or missing both id and label
        if (!row || (!row.id && !row.label)) {
            return;
        }
        // Pass the row data directly - createRow will handle finding the option
        createRow({
            label: row.label || '',
            id: row.id || '',
            type: row.type || 'Product',
            qty: row.qty || 0,
            unit: row.unit || 'ml',
            code: row.code || ''
        });
    });
    updateTotalCost();
}

// Ensure at least one editable row exists
if (rowsContainer.querySelectorAll('.ingredient-row').length === 0) {
    createRow();
}
</script>
{% endblock %}
